#!/bin/sh
# FreeBSD Container Init Script
# Mimics s6-overlay behavior for FreeBSD containers

set -e

echo "[init] Starting container initialization..."

# Save environment for services
mkdir -p /run/s6/container-environment
export -p > /run/s6/container-environment/all_envs

# Configure loopback interface (needed for healthchecks and localhost access)
ifconfig lo0 inet 127.0.0.1/8 up || true
ifconfig lo0 inet6 ::1/128 up 2>/dev/null || true

# Run built-in init scripts
if [ -d /etc/cont-init.d ]; then
    for script in /etc/cont-init.d/*; do
        if [ -x "$script" ]; then
            echo "[init] Running: $script"
            "$script"
        fi
    done
fi

# Run custom init scripts
if [ -d /custom-cont-init.d ]; then
    for script in /custom-cont-init.d/*; do
        if [ -x "$script" ]; then
            echo "[init] Running custom: $script"
            "$script"
        fi
    done
fi

echo "[init] Initialization complete"

# Auto-register services
if [ -d /etc/services.d ]; then
    for service in /etc/services.d/*; do
        if [ -d "$service" ]; then
            service_name="${service##*/}"
            service_run_dir="/run/s6/services/$service_name"
            
            # Link the main service
            ln -sf "$service" "$service_run_dir"
            
            # Auto-generate log service if it doesn't exist and logging is enabled
            if [ "${S6_LOG_ENABLE:-1}" = "1" ] && [ ! -d "$service/log" ]; then
                mkdir -p "$service_run_dir/log"
                printf "#!/bin/sh\nexec s6-log-helper %s\n" "$service_name" > "$service_run_dir/log/run"
                chmod +x "$service_run_dir/log/run"
            fi

            # Auto-generate finish script if it doesn't exist
            if [ ! -f "$service/finish" ]; then
                printf "#!/bin/sh\nexec s6-finish-helper \"\$@\"\n" > "$service_run_dir/finish"
                chmod +x "$service_run_dir/finish"
            fi
        fi
    done
fi

# If there are services to supervise, start s6-svscan
if [ -d /run/s6/services ] && [ "$(ls -A /run/s6/services 2>/dev/null)" ]; then
    echo "[init] Starting s6 supervision..."
    exec s6-svscan /run/s6/services
fi

# Otherwise, exec the CMD
if [ $# -gt 0 ]; then
    echo "[init] Executing: $@"
    exec "$@"
fi

# If no CMD and no services, just keep container alive
echo "[init] No services or command, sleeping..."
exec sleep infinity